<!DOCTYPE html>
<html>
<head>
    <title>OAuth Debug</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
        button { padding: 10px 15px; background: #2ea44f; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #2c974b; }
    </style>
</head>
<body>
    <h1>OAuth Debug</h1>
    <button id="startOAuth">Start OAuth Flow</button>
    <h2>Logs:</h2>
    <pre id="log"></pre>

    <script>
        const log = document.getElementById('log');
        const appendLog = (message) => {
            log.textContent += message + '\n';
            log.scrollTop = log.scrollHeight;
        };

        document.getElementById('startOAuth').addEventListener('click', async () => {
            try {
                // Generate a random state
                const state = Math.random().toString(36).substring(2, 15);
                
                // Store state in sessionStorage
                sessionStorage.setItem('oauth_state', state);
                
                // Generate PKCE code verifier and challenge
                const codeVerifier = generateCodeVerifier();
                const codeChallenge = await generateCodeChallenge(codeVerifier);
                
                // Store code verifier in sessionStorage
                sessionStorage.setItem('code_verifier', codeVerifier);
                
                // Build the OAuth URL
                const oauthUrl = new URL('https://github.com/login/oauth/authorize');
                oauthUrl.searchParams.append('client_id', 'Ov23lilcBd8JkV3HWZbE');
                oauthUrl.searchParams.append('redirect_uri', 'https://joru10-cms-oauth.onrender.com/callback');
                oauthUrl.searchParams.append('scope', 'repo');
                oauthUrl.searchParams.append('state', state);
                oauthUrl.searchParams.append('code_challenge', codeChallenge);
                oauthUrl.searchParams.append('code_challenge_method', 'S256');
                
                appendLog('Opening OAuth URL: ' + oauthUrl.toString());
                window.location.href = oauthUrl.toString();
                
            } catch (error) {
                appendLog('Error: ' + error.message);
                console.error(error);
            }
        });

        // PKCE Helper Functions
        function generateCodeVerifier() {
            const array = new Uint8Array(32);
            window.crypto.getRandomValues(array);
            return Array.from(array, byte => ('0' + byte.toString(16)).slice(-2)).join('');
        }

        async function generateCodeChallenge(codeVerifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(codeVerifier);
            const digest = await window.crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode(...new Uint8Array(digest)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }
    </script>
</body>
</html>
