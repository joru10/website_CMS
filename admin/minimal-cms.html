<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Minimal CMS</title>
  <!-- Netlify Identity for parity with main admin page -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <style>
    body { margin: 0; padding: 20px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    #nc-root { margin-top: 20px; border: 1px solid #e1e1e1; border-radius: 4px; min-height: 80vh; }
  </style>
</head>
<body>
  <h1>Minimal CMS</h1>
  <div id="diagnostics" style="margin-top:10px;font-size:14px;">
    <strong>Diagnostics:</strong>
    <a href="/oauth/version" target="_blank" rel="noopener">/oauth/version</a> ·
    <a href="/oauth/client_id" target="_blank" rel="noopener">/oauth/client_id</a>
  </div>
  <div id="nc-root"></div>
  
  <script>
    // Prevent Decap from auto-loading config.yml; support both legacy and new flags
    window.CMS_MANUAL_INIT = true;
    window.DecapCMS_MANUAL_INIT = true;
  </script>
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  
  <!-- OAuth + SlugGuard helpers (ported from admin/index.html) -->
  <script>
    // Utility to call a callback once CMS APIs are ready
    function whenCMSReady(cb) {
      if (window.CMS && typeof window.CMS.init === 'function') return cb();
      setTimeout(() => whenCMSReady(cb), 50);
    }

    // Slug guard to keep files-collection slug stable and provide visibility
    function defineSlugGuard() {
      try {
        if (window.__slugGuardDefined) return;
        window.__slugGuardDefined = true;
        window.__ensureSlugFromRoute = function({ entry, collection }) {
          try {
            var collName = collection && (collection.get ? collection.get('name') : collection.name);
            var current = entry ? (entry.get ? entry.get('slug') : entry.slug) : undefined;
            console.log('[SlugGuard] event fired', { coll: collName, slug: current });
            if (collName !== 'sitecontent' || !entry) return;
            var forced = 'claims';
            var newEntry = entry;
            if (entry && entry.get && entry.set) {
              if (current !== forced) {
                console.log('[SlugGuard] Forcing slug for sitecontent (Immutable) =>', forced, '(was:', current, ')');
                newEntry = entry.set('slug', forced);
              } else {
                console.log('[SlugGuard] Slug already set (Immutable) =>', current);
              }
            } else {
              if (current !== forced) {
                console.log('[SlugGuard] Forcing slug for sitecontent (plain) =>', forced, '(was:', current, ')');
                try { newEntry = Object.assign({}, entry, { slug: forced }); }
                catch(_e) { newEntry = entry; }
              } else {
                console.log('[SlugGuard] Slug already set (plain) =>', current);
              }
            }
            return { entry: newEntry };
          } catch (e) { console.warn('[SlugGuard] handler error', e); }
        };
        window.addEventListener('hashchange', function(){
          try {
            var h = (window.location.hash || '').replace(/^#!/, '#');
            var m = h.match(/#\/collections\/[^/]+\/entries\/([^/?#]+)/);
            var routeSlug = (m && m[1]) ? decodeURIComponent(m[1]) : undefined;
            console.log('[SlugGuard] hashchange route slug =', routeSlug);
          } catch(e){}
        });
      } catch(e) { console.warn('Failed to define slug guard', e); }
    }

    // OAuth postMessage handler and helpers
    window.authSuccess = false;
    window._exchangeInProgress = false;
    window._oauthProcessed = false;
    window._processedStates = new Set();
    window._fallbackTimers = new Map();

    window.addEventListener('message', function(event) {
      try { console.log('OAuth postMessage received:', { origin: event.origin, data: event.data }); } catch (e) {}
      if (event.origin !== window.location.origin) return;
      const message = event.data || {};
      if (message.state && window._processedStates.has(message.state)) {
        try { console.log('State already processed; ignoring message'); } catch (e) {}
        return;
      }
      if (message.type === 'authorization:github:success' && message.response) {
        return handleAuthSuccess(message.response);
      }
      if (message.type === 'authorization:github:error') {
        console.error('GitHub OAuth error:', message.error, message.error_description);
        alert(`Authentication failed: ${message.error_description || 'Unknown error'}`);
        return;
      }
      if (message.source === 'decap-cms' && message.code && message.state) {
        if (window._exchangeInProgress) { try { console.log('Exchange in progress; ignoring duplicate'); } catch(e){} return; }
        window._processedStates.add(message.state);
        try { console.log('Decap-style message detected; waiting briefly for legacy success before fallback exchange'); } catch(e){}
        if (window._fallbackTimers.has(message.state)) return;
        const t = setTimeout(function() {
          if (window._oauthProcessed || window.authSuccess) {
            try { console.log('Legacy success detected during wait; skipping fallback exchange'); } catch(e){}
            window._fallbackTimers.delete(message.state);
            return;
          }
          window._exchangeInProgress = true;
          try { console.log('Proceeding with fallback token exchange via /oauth/access_token'); } catch(e){}
          fetch('/oauth/access_token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ code: message.code, state: message.state })
          })
          .then(r => r.ok ? r.json() : r.text().then(t => { throw new Error(`HTTP ${r.status}: ${t}`); }))
          .then(json => {
            if (json && json.access_token) {
              handleAuthSuccess(json);
            } else {
              console.error('Token response missing access_token:', json);
              alert('Authentication failed: missing access token in response');
            }
          })
          .catch(err => {
            console.error('Token exchange failed:', err);
            alert('Authentication failed during token exchange');
          })
          .finally(() => { window._exchangeInProgress = false; window._fallbackTimers.delete(message.state); });
        }, 800);
        window._fallbackTimers.set(message.state, t);
      }
    });

    function handleAuthSuccess(response) {
      if (window.authSuccess) return;
      window.authSuccess = true;
      console.log('GitHub OAuth successful:', response);
      if (response && response.access_token) {
        window._oauthProcessed = true;
        const cmsUser = {
          token: response.access_token,
          login: 'github',
          provider: 'github',
          backendName: 'github',
          user: { login: 'github', name: 'GitHub User' },
          token_type: response.token_type || 'bearer'
        };
        localStorage.setItem('netlify-cms-user', JSON.stringify(cmsUser));
        localStorage.setItem('decap-cms-user', JSON.stringify(cmsUser));
        sessionStorage.setItem('netlify-cms-user', JSON.stringify(cmsUser));
        document.dispatchEvent(new CustomEvent('cms:auth:success', { detail: { token: response.access_token, provider: 'github', user: cmsUser } }));
        if (window.opener) {
          window.close();
        } else {
          console.log('Token stored; reloading once to let Decap restore session');
          try { sessionStorage.setItem('_cms_reload_after_auth', '1'); } catch(e){}
          try {
            const h = (window.location.hash || '').replace(/^#!/, '#');
            const target = (!h || h === '#/' || h === '#') ? '#/collections/sitecontent/entries/claims' : h;
            window.location.replace(window.location.pathname + target);
          } catch(e) { window.location.reload(); }
        }
      } else {
        console.error('No access token in response:', response);
      }
    }

    // Handle direct access_token URL parameter
    (function(){
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const accessToken = urlParams.get('access_token');
        if (accessToken) {
          const cleanUrl = window.location.origin + window.location.pathname;
          window.history.replaceState({}, document.title, cleanUrl);
          handleAuthSuccess({ access_token: accessToken, token_type: urlParams.get('token_type') || 'bearer', scope: urlParams.get('scope') || 'repo,user' });
        } else if (urlParams.get('auth') === 'success') {
          window._oauthProcessed = true;
          window.authSuccess = true;
          window.history.replaceState({}, document.title, window.location.pathname);
        }
      } catch(e){}
    })();

    // Mirror legacy user key to Decap key and handle post-auth reload
    document.addEventListener('DOMContentLoaded', function() {
      let afterAuthReload = false;
      try {
        if (sessionStorage.getItem('_cms_reload_after_auth') === '1') {
          afterAuthReload = true;
          sessionStorage.removeItem('_cms_reload_after_auth');
          window._skipOAuthPopup = true;
          console.log('Post-auth reload detected; skipping popup open');
        }
      } catch(e){}
      try {
        const u1 = localStorage.getItem('netlify-cms-user');
        const u2 = localStorage.getItem('decap-cms-user');
        if (u1 && !u2) {
          localStorage.setItem('decap-cms-user', u1);
          console.log('Mirrored netlify-cms-user -> decap-cms-user at load');
        }
      } catch(e){}
    });

    // Early register slug guard
    whenCMSReady(function(){
      try {
        defineSlugGuard();
        if (window.CMS && window.CMS.registerEventListener && window.__ensureSlugFromRoute) {
          window.CMS.registerEventListener({ name: 'preSave', handler: window.__ensureSlugFromRoute });
          window.CMS.registerEventListener({ name: 'prePublish', handler: window.__ensureSlugFromRoute });
          console.log('[SlugGuard] Registered preSave/prePublish listeners');
        }
      } catch(e) { console.warn('Failed to register slug guard early', e); }
    });
  </script>
  
  <script>
  // Minimal inline CMS config using the same OAuth function as /admin
  (function() {
    if (typeof CMS === 'undefined') {
      var root = document.getElementById('nc-root');
      if (root) root.innerHTML = '<div style="color: red; padding: 20px;">Error: CMS script failed to load.</div>';
      return;
    }

    const cmsConfig = {
      backend: {
        name: 'github',
        repo: 'joru10/website_CMS',
        branch: 'main',
        base_url: '/oauth',
        auth_endpoint: 'auth',
        auth_type: 'pkce',
        token_endpoint: 'access_token',
        cms_label_prefix: 'CMS',
        commit_messages: {
          create: 'Create {{collection}} “{{slug}}”',
          update: 'Update {{collection}} “{{slug}}”',
          delete: 'Delete {{collection}} “{{slug}}”',
          uploadMedia: 'Upload “{{path}}”',
          deleteMedia: 'Delete “{{path}}”',
          openAuthoring: '{{message}}'
        }
      },
      media_folder: 'static/uploads',
      public_folder: '/static/uploads',
      i18n: {
        structure: 'multiple_files',
        locales: ['en', 'es', 'fr'],
        default_locale: 'en'
      },
      publish_mode: 'simple',
      collections: [
        {
          name: 'sitecontent',
          label: 'Site Content (claims, stats)',
          delete: false,
          create: false,
          i18n: false,
          files: [
            {
              file: 'content.json',
              label: 'Claims & Stats',
              name: 'claims',
              i18n: false,
              format: 'json',
              fields: [
                { label: 'Items', name: 'items', widget: 'list', summary: '{{fields.key}}: {{fields.value}}', fields: [
                  { label: 'Key', name: 'key', widget: 'string' },
                  { label: 'Value', name: 'value', widget: 'string' }
                ]}
              ]
            }
          ]
        },
        {
          name: 'translations',
          label: 'Translations',
          label_singular: 'Translation file',
          delete: false,
          create: false,
          files: [
            { file: 'translations/en.json', name: 'en', label: 'English', format: 'json', fields: [
              { label: 'Strings', name: 'strings', widget: 'list', summary: '{{fields.key}}', fields: [
                { label: 'Key', name: 'key', widget: 'string' },
                { label: 'Value', name: 'value', widget: 'string' }
              ]}
            ]},
            { file: 'translations/es.json', name: 'es', label: 'Español (EU)', format: 'json', fields: [
              { label: 'Strings', name: 'strings', widget: 'list', summary: '{{fields.key}}', fields: [
                { label: 'Key', name: 'key', widget: 'string' },
                { label: 'Value', name: 'value', widget: 'string' }
              ]}
            ]},
            { file: 'translations/fr.json', name: 'fr', label: 'Français (EU)', format: 'json', fields: [
              { label: 'Strings', name: 'strings', widget: 'list', summary: '{{fields.key}}', fields: [
                { label: 'Key', name: 'key', widget: 'string' },
                { label: 'Value', name: 'value', widget: 'string' }
              ]}
            ]}
          ]
        },
        {
          name: 'intro',
          label: 'Homepage Hero',
          delete: false,
          create: false,
          i18n: true,
          folder: 'content/intro',
          format: 'json',
          slug: 'index',
          path: 'index',
          fields: [
            { label: 'Title (HTML allowed)', name: 'title', widget: 'text', i18n: true },
            { label: 'Subtitle', name: 'subtitle', widget: 'text', i18n: true },
            { label: 'Quote (HTML allowed)', name: 'quote', widget: 'text', i18n: true },
            { label: 'Signature (HTML allowed)', name: 'signature', widget: 'text', i18n: true },
            { label: 'CTA Label', name: 'cta', widget: 'string', i18n: true },
            { label: 'Image', name: 'image', widget: 'image', required: false, i18n: 'duplicate', hint: 'Recommended ~1200x800' },
            { label: 'Image Alt', name: 'image_alt', widget: 'string', required: false, i18n: true }
          ]
        },
        {
          name: 'about',
          label: 'About (Meet Jose)',
          delete: false,
          create: false,
          i18n: true,
          folder: 'content/about',
          format: 'json',
          slug: 'index',
          path: 'index',
          fields: [
            { label: 'Title (HTML allowed)', name: 'title', widget: 'text', i18n: true },
            { label: 'Description (HTML allowed)', name: 'description', widget: 'text', i18n: true },
            { label: 'Image', name: 'image', widget: 'image', required: false, i18n: 'duplicate', hint: 'Recommended ~800x600' },
            { label: 'Image Alt', name: 'image_alt', widget: 'string', required: false, i18n: true },
            { label: 'Bullets', name: 'bullets', widget: 'list', i18n: true, fields: [
              { label: 'Icon (CSS class)', name: 'icon', widget: 'string', required: false, i18n: 'duplicate', hint: 'e.g., fas fa-rocket' },
              { label: 'Text', name: 'text', widget: 'string', i18n: true }
            ]}
          ]
        },
        {
          name: 'resources_intro',
          label: 'Resources Intro',
          delete: false,
          create: false,
          i18n: true,
          folder: 'content/resources_intro',
          format: 'json',
          slug: 'index',
          path: 'index',
          fields: [
            { label: 'Title (HTML allowed)', name: 'title', widget: 'text', i18n: true },
            { label: 'Subtitle', name: 'subtitle', widget: 'text', i18n: true }
          ]
        },
        {
          name: 'values',
          label: 'Implementation Values',
          delete: false,
          create: false,
          i18n: true,
          folder: 'content/values',
          format: 'json',
          slug: 'index',
          path: 'index',
          fields: [
            { label: 'Title', name: 'title', widget: 'string', i18n: true },
            { label: 'Subtitle', name: 'subtitle', widget: 'text', i18n: true },
            { label: 'Items', name: 'items', widget: 'list', i18n: true, fields: [
              { label: 'Icon (CSS class)', name: 'icon', widget: 'string', i18n: 'duplicate', hint: 'e.g., fas fa-rocket' },
              { label: 'Title', name: 'title', widget: 'string', i18n: true },
              { label: 'Description', name: 'description', widget: 'text', i18n: true }
            ]},
            { label: 'CTA Title', name: 'cta_title', widget: 'string', required: false, i18n: true },
            { label: 'CTA Subtitle', name: 'cta_subtitle', widget: 'text', required: false, i18n: true }
          ]
        },
        {
          name: 'services',
          label: 'Services',
          label_singular: 'Service',
          folder: 'content/services',
          create: true,
          slug: '{{slug}}',
          format: 'frontmatter',
          path: '{{slug}}/index',
          i18n: true,
          fields: [
            { label: 'Title', name: 'title', widget: 'string', i18n: true },
            { label: 'Description', name: 'description', widget: 'text', i18n: true },
            { label: 'Features', name: 'features', widget: 'list', i18n: true, hint: 'One feature per item' },
            { label: 'Icon (CSS class)', name: 'icon', widget: 'string', required: false, hint: 'e.g., fas fa-brain', i18n: 'duplicate' },
            { label: 'Order', name: 'order', widget: 'number', value_type: 'int', min: 1, i18n: 'duplicate' },
            { label: 'Featured', name: 'featured', widget: 'boolean', default: false, i18n: 'duplicate' }
          ]
        },
        {
          name: 'blog',
          label: 'Blog Posts',
          folder: 'content/blog',
          create: true,
          slug: '{{slug}}',
          format: 'frontmatter',
          path: '{{slug}}/index',
          i18n: true,
          fields: [
            { label: 'Title', name: 'title', widget: 'string', i18n: true },
            { label: 'Date', name: 'date', widget: 'datetime', i18n: 'duplicate' },
            { label: 'Description', name: 'description', widget: 'text', i18n: true },
            { label: 'Cover (URL)', name: 'cover', widget: 'string', required: false, i18n: 'duplicate' },
            { label: 'Body', name: 'body', widget: 'markdown', i18n: true }
          ]
        },
        {
          name: 'education',
          label: 'Education Articles',
          folder: 'content/education',
          create: true,
          slug: '{{slug}}',
          format: 'frontmatter',
          path: '{{slug}}/index',
          i18n: true,
          fields: [
            { label: 'Title', name: 'title', widget: 'string', i18n: true },
            { label: 'Date', name: 'date', widget: 'datetime', i18n: 'duplicate' },
            { label: 'Description', name: 'description', widget: 'text', i18n: true },
            { label: 'Icon (CSS class)', name: 'icon', widget: 'string', required: false, i18n: 'duplicate' },
            { label: 'Body', name: 'body', widget: 'markdown', i18n: true }
          ]
        },
        {
          name: 'news',
          label: 'News',
          folder: 'content/news',
          create: true,
          slug: '{{slug}}',
          format: 'frontmatter',
          path: '{{slug}}/index',
          i18n: true,
          fields: [
            { label: 'Title', name: 'title', widget: 'string', i18n: true },
            { label: 'Date', name: 'date', widget: 'datetime', i18n: 'duplicate' },
            { label: 'Summary', name: 'summary', widget: 'text', i18n: true },
            { label: 'Body', name: 'body', widget: 'markdown', i18n: true }
          ]
        },
        {
          name: 'cases',
          label: 'Case Studies',
          folder: 'content/cases',
          create: true,
          slug: '{{slug}}',
          format: 'json',
          path: '{{slug}}/index',
          i18n: true,
          fields: [
            { label: 'Title', name: 'title', widget: 'string', i18n: true },
            { label: 'Industry', name: 'industry', widget: 'string', i18n: true },
            { label: 'Challenge', name: 'challenge', widget: 'markdown', i18n: true },
            { label: 'Solution', name: 'solution', widget: 'markdown', i18n: true },
            { label: 'Outcome', name: 'outcome', widget: 'markdown', i18n: true }
          ]
        },
        {
          name: 'testimonials',
          label: 'Testimonials',
          label_singular: 'Testimonial',
          folder: 'content/testimonials',
          create: true,
          slug: '{{slug}}',
          format: 'json',
          path: '{{slug}}/index',
          i18n: true,
          fields: [
            { label: 'Name', name: 'name', widget: 'string', i18n: 'duplicate' },
            { label: 'Title/Role', name: 'role', widget: 'string', required: false, i18n: true },
            { label: 'Company', name: 'company', widget: 'string', required: false, i18n: 'duplicate' },
            { label: 'Avatar', name: 'avatar', widget: 'image', required: false, i18n: 'duplicate' },
            { label: 'Badge (e.g., sector • size)', name: 'badge', widget: 'string', required: false, i18n: true },
            { label: 'Delivery (e.g., 2 weeks delivery)', name: 'delivery', widget: 'string', required: false, i18n: true },
            { label: 'Stars (1-5)', name: 'stars', widget: 'number', min: 1, max: 5, default: 5, i18n: 'duplicate' },
            { label: 'Quote', name: 'quote', widget: 'text', i18n: true },
            { label: 'Metric 1 Label', name: 'metric1_label', widget: 'string', required: false, i18n: true },
            { label: 'Metric 1 Value', name: 'metric1_value', widget: 'string', required: false, i18n: true },
            { label: 'Metric 2 Label', name: 'metric2_label', widget: 'string', required: false, i18n: true },
            { label: 'Metric 2 Value', name: 'metric2_value', widget: 'string', required: false, i18n: true },
            { label: 'Social Note (e.g., Verified on LinkedIn)', name: 'social_note', widget: 'string', required: false, i18n: true },
            { label: 'LinkedIn URL', name: 'linkedin_url', widget: 'string', required: false, i18n: 'duplicate' }
          ]
        },
        {
          name: 'partners',
          label: 'Partners',
          label_singular: 'Partner',
          folder: 'content/partners',
          create: true,
          slug: '{{slug}}',
          format: 'json',
          path: '{{slug}}/index',
          i18n: true,
          fields: [
            { label: 'Name', name: 'name', widget: 'string', i18n: 'duplicate' },
            { label: 'Tagline', name: 'tagline', widget: 'string', required: false, i18n: true },
            { label: 'Description', name: 'description', widget: 'text', i18n: true },
            { label: 'Badge (e.g., Category • Region)', name: 'badge', widget: 'string', required: false, i18n: true },
            { label: 'Website URL', name: 'website_url', widget: 'string', required: false, i18n: 'duplicate' },
            { label: 'Icon (CSS class, optional)', name: 'icon', widget: 'string', required: false, i18n: 'duplicate' }
          ]
        }
      ]
    };

    // Optional debug filters via URL params: ?only=blog (keeps one collection)
    try {
      const params = new URLSearchParams(window.location.search);
      const only = params.get('only');
      if (only) {
        const before = cmsConfig.collections.length;
        cmsConfig.collections = cmsConfig.collections.filter(c => c && c.name === only);
        console.log(`[Minimal CMS] Filtered collections by ?only=${only} (${before} -> ${cmsConfig.collections.length})`);
      }
      // Pre-init validation
      cmsConfig.collections.forEach((c, idx) => {
        if (!c || !c.name) {
          console.error('[Minimal CMS] Invalid collection at index', idx, c);
        }
        if (c.files && !Array.isArray(c.files)) {
          console.error(`[Minimal CMS] Collection ${c.name} has invalid files spec`, c.files);
        }
        if (c.folder && typeof c.folder !== 'string') {
          console.error(`[Minimal CMS] Collection ${c.name} has invalid folder spec`, c.folder);
        }
      });
      console.log('[Minimal CMS] Collections:', cmsConfig.collections.map(c => c.name));
    } catch(e) { console.warn('[Minimal CMS] Debug prep failed', e); }

    try { console.log('[Minimal CMS] Initializing Decap with inline config'); } catch(e){}
    if (typeof window.initCMS === 'function') {
      window.initCMS({ config: cmsConfig, load_config_file: false });
    } else if (typeof window.CMS !== 'undefined' && typeof window.CMS.init === 'function') {
      window.CMS.init({ config: cmsConfig, load_config_file: false });
    } else {
      var root2 = document.getElementById('nc-root');
      if (root2) root2.innerHTML = '<div style="color:red;padding:20px;">Error: Decap CMS not initialized.</div>';
    }
    // Post-init: re-register slug guard and normalize default route
    try {
      setTimeout(function(){
        try {
          if (window.CMS && window.CMS.registerEventListener && window.__ensureSlugFromRoute) {
            window.CMS.registerEventListener({ name: 'preSave', handler: window.__ensureSlugFromRoute });
            window.CMS.registerEventListener({ name: 'prePublish', handler: window.__ensureSlugFromRoute });
            console.log('[SlugGuard] Re-registered listeners after CMS.init');
          }
        } catch(e) { console.warn('[SlugGuard] Post-init registration error', e); }
        try {
          var h = (window.location.hash || '').replace(/^#!/, '#');
          if (!h || h === '#/' || h === '#') {
            console.log('Routing to sitecontent single entry: claims');
            window.location.hash = '#/collections/sitecontent/entries/claims';
          }
        } catch(e) { console.warn('Route normalizer failed', e); }
        try {
          if (window.CMS && window.CMS.getConfig) {
            var cfg = window.CMS.getConfig();
            console.log('Effective CMS config:', (cfg && cfg.toJS) ? cfg.toJS() : cfg);
          }
        } catch (e) { console.warn('Could not log effective CMS config', e); }
      }, 150);
    } catch(e){}
  })();
  </script>
</body>
</html>
