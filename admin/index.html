<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:; connect-src 'self' https://api.github.com https://github.com https://*.github.com https://comfy-panda-0d488a.netlify.app https://joru10-cms-oauth.onrender.com; frame-src 'self' https://github.com https://*.github.com; frame-ancestors 'self'; object-src 'none'" />
  <title>Content Manager | RapidAI</title>
</head>
<body>
  <div id="nc-root"></div>
  <!-- Prevent auto-init and explicitly point to the root config -->
  <script>
    window.CMS_MANUAL_INIT = true;
  </script>
  <script>
    // Debug: log OAuth popup messages reaching the admin window
    window.addEventListener('message', function (e) {
      try {
        console.log('oauth message', e && e.data);
      } catch (_) {}
    });
  </script>
  <script>
    // Resilient loader: try multiple CDNs/versions until one succeeds
    (function () {
      const sources = [
        '/admin/decap-cms.js?v=20250810-csp7',
        'https://unpkg.com/decap-cms@^3/dist/decap-cms.js',
        'https://cdn.jsdelivr.net/npm/decap-cms@3/dist/decap-cms.js',
        'https://unpkg.com/decap-cms@^2/dist/decap-cms.js',
        'https://cdn.jsdelivr.net/npm/decap-cms@2/dist/decap-cms.js'
      ];

      function loadNext(i) {
        if (i >= sources.length) {
          console.error('All Decap CMS CDN sources failed to load.');
          return;
        }
        const src = sources[i];
        const s = document.createElement('script');
        s.src = src;
        s.async = true;
        s.crossOrigin = 'anonymous';
        s.onload = async function () {
          console.log('Decap CMS loaded from', src);
          if (typeof CMS !== 'undefined') {
            // Manual init with inline config only (no external fetch) for all environments
            // The oauthBase should always point to our deployed Render service.
            const oauthBase = 'https://joru10-cms-oauth.onrender.com';

            // Allow passing public client_id via query param or localStorage for PKCE fallback
            try {
              const qp = new URLSearchParams(location.search);
              const qid = qp.get('client_id');
              if (qid) {
                window.CMS_GITHUB_CLIENT_ID = qid;
                try { localStorage.setItem('CMS_GITHUB_CLIENT_ID', qid); } catch(_) {}
              }
              if (!window.CMS_GITHUB_CLIENT_ID) {
                try { const v = localStorage.getItem('CMS_GITHUB_CLIENT_ID'); if (v) window.CMS_GITHUB_CLIENT_ID = v; } catch(_) {}
              }
            } catch(_) {}
            // Build backend dynamically: prefer PKCE if client_id can be retrieved
            async function buildBackend() {
              const backend = {
                name: 'github',
                repo: 'joru10/website_CMS',
                branch: 'main',
                base_url: oauthBase,
                auth_endpoint: '/auth',
              };
              try {
                const resp = await fetch(oauthBase + '/client_id', { method: 'GET', credentials: 'omit' });
                if (resp && resp.ok) {
                  const data = await resp.json().catch(() => ({}));
                  if (data && data.client_id) {
                    backend.auth_type = 'pkce';
                    backend.app_id = data.client_id;
                    backend.token_endpoint = '/access_token';
                    console.log('Decap backend: using PKCE with app_id suffix', String(data.client_id).slice(-4));
                  } else {
                    console.log('Decap backend: client_id not present, using classic flow');
                  }
                } else {
                  console.log('Decap backend: client_id fetch failed or not available (status)', resp && resp.status);
                }
              } catch (e) {
                console.log('Decap backend: client_id fetch error, using classic flow', e && e.message);
              }
              // Optional fallback: allow setting public client_id via global for PKCE
              if (!backend.app_id && typeof window !== 'undefined' && window.CMS_GITHUB_CLIENT_ID) {
                backend.auth_type = 'pkce';
                backend.app_id = window.CMS_GITHUB_CLIENT_ID;
                backend.token_endpoint = '/access_token';
                console.log('Decap backend: using PKCE (window.CMS_GITHUB_CLIENT_ID) suffix', String(backend.app_id).slice(-4));
              }
              return backend;
            }
            const config = {
              backend: await buildBackend(),
              local_backend: false,
              i18n: {
                structure: 'multiple_files',
                locales: ['en', 'es', 'fr'],
                default_locale: 'en',
              },
              media_folder: 'static/uploads',
              public_folder: '/uploads',
              collections: [
                {
                  name: 'services',
                  label: 'Services',
                  folder: 'content/services',
                  nested: { depth: 1 },
                  extension: 'md',
                  path: '{{slug}}/index',
                  create: true,
                  slug: '{{slug}}',
                  i18n: true,
                  format: 'frontmatter',
                  fields: [
                    { label: 'Title', name: 'title', widget: 'string', i18n: true },
                    { label: 'Description', name: 'description', widget: 'markdown', i18n: true },
                    { label: 'Icon', name: 'icon', widget: 'string' },
                    { label: 'Order', name: 'order', widget: 'number', value_type: 'int' },
                    { label: 'Featured', name: 'featured', widget: 'boolean' },
                    { label: 'Feature 1', name: 'feature1', widget: 'string', i18n: true },
                    { label: 'Feature 2', name: 'feature2', widget: 'string', i18n: true },
                    { label: 'Feature 3', name: 'feature3', widget: 'string', i18n: true },
                  ],
                },
                {
                  name: 'translations',
                  label: 'Translations',
                  label_singular: 'Translation file',
                  delete: false,
                  files: [
                    {
                      file: 'translations/en.json',
                      name: 'en',
                      label: 'English',
                      format: 'json',
                      fields: [
                        {
                          label: 'Strings',
                          name: 'strings',
                          widget: 'list',
                          summary: '{{fields.key}}',
                          fields: [
                            { label: 'Key', name: 'key', widget: 'string' },
                            { label: 'Value', name: 'value', widget: 'string' },
                          ],
                        },
                      ],
                    },
                    {
                      file: 'translations/es.json',
                      name: 'es',
                      label: 'Español (EU)',
                      format: 'json',
                      fields: [
                        {
                          label: 'Strings',
                          name: 'strings',
                          widget: 'list',
                          summary: '{{fields.key}}',
                          fields: [
                            { label: 'Key', name: 'key', widget: 'string' },
                            { label: 'Value', name: 'value', widget: 'string' },
                          ],
                        },
                      ],
                    },
                    {
                      file: 'translations/fr.json',
                      name: 'fr',
                      label: 'Français (EU)',
                      format: 'json',
                      fields: [
                        {
                          label: 'Strings',
                          name: 'strings',
                          widget: 'list',
                          summary: '{{fields.key}}',
                          fields: [
                            { label: 'Key', name: 'key', widget: 'string' },
                            { label: 'Value', name: 'value', widget: 'string' },
                          ],
                        },
                      ],
                    },
                  ],
                },
                {
                  name: 'blog',
                  label: 'Blog Posts',
                  folder: 'blog',
                  create: true,
                  slug: '{{slug}}',
                  format: 'frontmatter',
                  fields: [
                    { label: 'Title', name: 'title', widget: 'string' },
                    { label: 'Date', name: 'date', widget: 'datetime' },
                    { label: 'Summary', name: 'summary', widget: 'text' },
                    { label: 'Body', name: 'body', widget: 'markdown' },
                  ],
                },
                {
                  name: 'education',
                  label: 'Education Articles',
                  folder: 'education',
                  create: true,
                  slug: '{{slug}}',
                  format: 'frontmatter',
                  fields: [
                    { label: 'Title', name: 'title', widget: 'string' },
                    { label: 'Date', name: 'date', widget: 'datetime' },
                    { label: 'Summary', name: 'summary', widget: 'text' },
                    { label: 'Body', name: 'body', widget: 'markdown' },
                  ],
                },
                {
                  name: 'news',
                  label: 'News',
                  folder: 'news',
                  create: true,
                  slug: '{{slug}}',
                  format: 'frontmatter',
                  fields: [
                    { label: 'Title', name: 'title', widget: 'string' },
                    { label: 'Date', name: 'date', widget: 'datetime' },
                    { label: 'Summary', name: 'summary', widget: 'text' },
                    { label: 'Body', name: 'body', widget: 'markdown' },
                  ],
                },
                {
                  name: 'cases',
                  label: 'Case Studies',
                  folder: 'cases',
                  create: true,
                  slug: '{{slug}}',
                  format: 'json',
                  fields: [
                    { label: 'Title', name: 'title', widget: 'string' },
                    { label: 'Industry', name: 'industry', widget: 'string' },
                    { label: 'Challenge', name: 'challenge', widget: 'markdown' },
                    { label: 'Solution', name: 'solution', widget: 'markdown' },
                    { label: 'Outcome', name: 'outcome', widget: 'markdown' },
                  ],
                },
                {
                  name: 'content',
                  label: 'Site Content (claims, stats)',
                  delete: false,
                  files: [
                    {
                      file: 'content.json',
                      label: 'Claims & Stats',
                      name: 'claims',
                      format: 'json',
                      fields: [
                        {
                          label: 'Data',
                          name: 'data',
                          widget: 'list',
                          summary: '{{fields.key}}: {{fields.value}}',
                          fields: [
                            { label: 'Key', name: 'key', widget: 'string' },
                            { label: 'Value', name: 'value', widget: 'string' },
                          ],
                        },
                      ],
                    },
                  ],
                },
              ],
            };
            // Diagnostics: log duplicates prior to init
            try {
              const locales = (config.i1n && config.i1n.locales) || [];
              const dupLocales = locales.filter((v, i, a) => a.indexOf(v) !== i);
              const names = (config.collections || []).map(c => c.name);
              const dupCollections = names.filter((v, i, a) => a.indexOf(v) !== i);
              console.log('Decap inline config summary', { locales, dupLocales, collectionCount: names.length, dupCollections });
            } catch (e) {
              console.warn('Config diagnostics failed', e);
            }
            console.log('Initializing Decap CMS with inline config (load_config_file=false)');
            try {
              // Make config available for any consumers checking the global
              window.CMS_CONFIG = config;
              CMS.init({ config, load_config_file: false });
            } catch (e) {
              console.error('CMS.init failed', e);
            }
            // One-time snapshot for diagnostics
            try {
              const cfg = CMS && CMS.getConfig ? CMS.getConfig() : null;
              const js = cfg && typeof cfg.toJS === 'function' ? cfg.toJS() : cfg;
              console.log('CMS.getConfig() after init', js || cfg);
            } catch (_) {}
          } else {
            console.error('CMS global not found after loading', src);
          }
        };
        s.onerror = function () {
          console.warn('Failed to load', src, '— trying next CDN');
          loadNext(i + 1);
        };
        document.head.appendChild(s);
      }

      document.addEventListener('DOMContentLoaded', function () {
        loadNext(0);
      });
    })();
  </script>
</body>
</html>
